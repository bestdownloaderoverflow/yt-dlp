services:
  # --- VPN Container ---
  gluetun:
    image: qmcgaw/gluetun:v3.41
    container_name: gluetun-yt-dlp
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "3021:3021"  # yt-dlp server port
      - "8000:8000"  # gluetun control server
    environment:
      - VPN_SERVICE_PROVIDER=ivpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=sHTYRL4dE0W7nsCvA3r6nloB1Nxyf8cOY9lSL0NLPns=
      - WIREGUARD_ADDRESSES=172.18.96.196/32
      - SERVER_COUNTRIES=Singapore
      - DNS_ADDRESS=172.16.0.1
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - HTTP_CONTROL_SERVER_LOG=on
      - "HTTP_CONTROL_SERVER_AUTH_DEFAULT_ROLE={\"auth\":\"basic\",\"username\":\"admin\",\"password\":\"secretpassword\"}"
    volumes:
      - ./gluetun/data:/gluetun
    restart: unless-stopped
    networks:
      - tiktok_network

  # --- yt-dlp Server (routes through gluetun) ---
  yt-dlp-server:
    build:
      context: ..
      dockerfile: serverjs/Dockerfile
    container_name: yt-dlp-tiktok-server
    restart: unless-stopped
    network_mode: "service:gluetun"  # Route traffic through VPN
    depends_on:
      - gluetun
    environment:
      - NODE_ENV=production
      - PORT=3021
      - BASE_URL=https://d.snaptik.fit  # Change this to your actual public URL in production
      - ENCRYPTION_KEY=overflow  # Change this to a secure key in production
      - YT_DLP_PATH=/usr/local/bin/yt-dlp.sh  # Uses wrapper that checks /app/yt-dlp.sh first
      - FFMPEG_PATH=ffmpeg
      - TEMP_DIR=./temp
    volumes:
      - ./temp:/app/serverjs/temp
      # Mount yt-dlp.sh from parent directory (optional, for updates)
      # - ../yt-dlp.sh:/app/yt-dlp.sh:ro

networks:
  tiktok_network:
    driver: bridge
